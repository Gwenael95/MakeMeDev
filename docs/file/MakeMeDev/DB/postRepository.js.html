<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">MakeMeDev/DB/postRepository.js | makemedev</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="projet web 2020"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="makemedev"><meta property="twitter:description" content="projet web 2020"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Gwenael95/MakeMeDev"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">MakeMeDev/DB/postRepository.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * This file requires {@link module:../Models/postModel}, {@link module:../Tools/DB/postPipeline},
 * {@link module:../Tools/DB/postHelper}.
 * @requires module:../Models/postModel&quot;
 * @requires module:../Tools/DB/postPipeline
 * @requires module:../Tools/DB/postHelper
 */
const mongoose = require(&apos;mongoose&apos;);
const {postSchema} = require(&quot;../Models/postModel&quot;);
const {getPipeline} = require(&quot;../Tools/DB/postPipeline&quot;)
const {getLastResponseId, getLastCommentaryId} = require(&quot;../Tools/DB/postHelper&quot;)

/**
 * A mongoose post model
 * @type {Model&lt;Document&gt;}
 */
const PostModel = mongoose.model(&apos;posts&apos;, postSchema)
const ObjectId = mongoose.Types.ObjectId;


//region get
/** @function
 * @name getPostByFunction
 * Get post in database depending on many criteria, and return the result of this try
 * @param {object} searchedData - data to search in database
 * @returns {Promise&lt;{success: {success: T}}|{error: Error.ValidationError | {[p: string]: ValidatorError | CastError} | number}&gt;}
 */
async function getPostByFunction(searchedData) {
    return await PostModel
        .aggregate(getPipeline(searchedData))//.sort({&quot;post.totalLike&quot;:1})
        .exec()
        .then(result =&gt; {return {success: result}})
        .catch(err =&gt; {
            return {error: err.errors}
        });
}

/** @function
 * @name getPostById
 * Get post in database depending on post&apos;s Id, and return the result of this try
 * @param {object} postId - post&apos;s Id to search in database
 * @returns {Promise&lt;{success: {success: T}}|{error: Error.ValidationError | {[p: string]: ValidatorError | CastError} | number}&gt;}
 */
async function getPostById(postId) {
    return await PostModel
        .findOne({_id: ObjectId(postId)})
        .exec()
        .then(result =&gt; {return {success: result}})
        .catch(err =&gt; {
            return {error: err.errors}
        });
}
//endregion

//region post
/** @function
 * @name addPost
 * Insert a new post in database, and return the result of this try
 * @param {object} postData - post to add, should correspond to postModels {@link &apos;../Models/postModels&apos;}.
 * @returns {Promise&lt;{success: {success: T}}|{error: Error.ValidationError | {[p: string]: ValidatorError | CastError} | number}&gt;}
 */
async function addPost(postData, user) {
    const doc = new PostModel(postData);
    return await doc.save().then(result =&gt; {
        return {success: result}
    }).catch(err =&gt; {
        return {error: err.errors}
    })
}
//endregion

//region patch

/** @function
 * @name updatePost
 * A generic function used to update a post.
 * @param {object} filter - object used by mongoDB to select corresponding documents in DB.
 * @param {object} update - object containing fields to set (ex: $set, or $push).
 * @param {string} id - a post&apos;s id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}&gt;}
 */
async function updatePost(filter, update, id) {
    return await PostModel
        .findOneAndUpdate(
            filter,
            update,
            {new: true, context: &quot;query&quot;})
        .lean()
        .exec()
        .then((result ) =&gt; {
            return {success: result, postId: id , responseId: getLastResponseId(result), commentaryId: getLastCommentaryId(result, id)}
        })
        .catch(err =&gt; {
            return {error: err.errors}
        });
}

/** @function
 * @name updatePostFunction
 * Update a post function.
 * @param {string} functionPost - the new function
 * @param {string} idPost - a post&apos;s id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}&gt;}
 */
async function updatePostFunction(functionPost, idPost) {
    return await updatePost({&quot;post._id&quot;: ObjectId(idPost)}, {$set : {&quot;post.$.function&quot;: functionPost}}, idPost)
}

/** @function
 * @name pushPostResponse
 * Add a post response.
 * @param {object} responsePost - a new response post to add in an array in DB
 * @param idPost - a post&apos;s id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}&gt;}
 */
async function pushPostResponse(responsePost, idPost) {
    return await updatePost({&quot;_id&quot;: ObjectId(idPost)}, {$push : {post: responsePost}}, idPost)
}

/** @function
 * @name pushPostResponseCommentary
 * Add a post commentary.
 * @param {object} commentaryResponse -  a new commentary to add in an array in DB
 * @param idPost - a post&apos;s id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}&gt;}
 */
async function pushPostResponseCommentary(commentaryResponse, idPost) {
    return await updatePost({&quot;post._id&quot;: ObjectId(idPost)}, {$push : {&quot;post.$.commentary&quot;: commentaryResponse}}, idPost)
}

/** @function
 * @name updateLikeOrDislike
 * Add or update like/dislike for a post.
 * start by checking if user already vote for this post.
 * if not we increment the like/dislike counter.
 * else, if it changes is mind (want to change a like by a dislike), we decrement
 * the old vote and increase the new one.
 * @param {string} likeOrDislike - a string equals to &apos;like&apos; or &apos;dislike&apos;
 * @param {string} idPost - post&apos;s id
 * @param {object} user - user&apos;s data (needed to know his activities)
 * @returns {Promise&lt;{error: string}|*&gt;}
 */
async function updateLikeOrDislike(likeOrDislike, idPost, user) {
    /**
     * A string, opposite to the current vote
     * @type {string}
     */
    let opposite = {like:&quot;dislike&quot;, dislike:&quot;like&quot;}[likeOrDislike]
    /**
     * An object containing fields to set in DB
     * @type {object}
     */
    let setPost

    if (!(user.activities[likeOrDislike].includes(idPost) || user.activities[opposite].includes( idPost))) {
        setPost = {$inc: {[&quot;post.$.&quot; + likeOrDislike]:1}}
    }
    else if(user.activities[opposite].includes( idPost)) {
        setPost = {$inc: {[&quot;post.$.&quot; + likeOrDislike]:1, [&quot;post.$.&quot; + opposite]:-1}}
    }
    else{
        return {error:&quot;cet utilisateur &#xE0; d&#xE9;j&#xE0; mis un &quot; + likeOrDislike}
    }
    return await updatePost({&quot;post._id&quot;: ObjectId(idPost)}, setPost, idPost)
}
//endregion


module.exports = {addPost, getPostByFunction, getPostById, updateLikeOrDislike,
    pushPostResponse, pushPostResponseCommentary, updatePostFunction};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
