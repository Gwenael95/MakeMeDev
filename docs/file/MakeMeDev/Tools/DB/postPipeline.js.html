<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">MakeMeDev/Tools/DB/postPipeline.js | makemedev</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="projet web 2020"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="makemedev"><meta property="twitter:description" content="projet web 2020"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Gwenael95/MakeMeDev"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">MakeMeDev/Tools/DB/postPipeline.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * This file requires {@link module:../Common/countOccurrence}, {@link module:../Common/stringOperation}.
 * @requires module:../Common/countOccurrence
 * @requires module:../Common/stringOperation
 */
const {countOccurrencesFromArray} = require(&quot;../Common/countOccurrence&quot;);
const {filterDelSpaces} = require(&quot;../Common/stringOperation&quot;);

//region exported

/** @function
 * @name getPipeline
 * Get a complex Pipeline to search all function depending on data search criteria
 * @param {object} data - post&apos;s data
 * @returns {[]}
 */
function getPipeline(data) {
    return getNameQuery(data)
        .concat(getParamTypeQuery(data), getReturnTypeQuery(data), getDescriptionQuery(data), getTagQuery(data));
}
//endregion

//region pipeline back

//region query for string&apos;s array

/** @function
 * @name getMatchFromStringArray
 * Create a $match for a defined field from database containing an array
 * Check if another array contains some or all elements of this DB field
 * @param {string|null} data - an array containing strings, or null (then return empty array)
 * @param {string} dbField - field name from DB
 * @returns {[]|[{$match: {field:{$all:data}}}]}
 */
function getMatchFromStringArray(data, dbField) {
    if (data !== null) {
        let array = (filterDelSpaces(data).split(&quot;,&quot;))
        if (array.length &gt; 0 &amp;&amp; data!==&quot;&quot;) {
            return [{$match: {[dbField]: {$all: array}}}]
        }
        else if (data===&quot;&quot;) {
            return [{$match: {[dbField]:{$size: 0}}}]
        }
    }
    return []
}

/** @function
 * @name getTagQuery
 * Get a query to search all post&apos;s tags in DB
 * @param {object} data - post&apos;s data
 * @returns {*[]|{$match: {field: {$all: data}}}[]}
 */
function getTagQuery(data) {
    return getMatchFromStringArray(data.tag, &quot;tag&quot;)
}

//endregion

//region query for returns/params array
/** @function
 * @name getTabParamOrReturn
 * A complex function, used to prepare a mongo filter for returns or params types.
 * @param {object} data - post&apos;s data
 * @param {string} dbFieldNameCount - field name that contain the count of each types
 * @param {string} paramsOrResults - array field name from DB that contains type (returns or params)
 * @returns {unknown[]|[]|{$match: {}}[]}
 */
function getTabParamOrReturn(data, dbFieldNameCount, paramsOrResults) {
    let paramOrResultTypeQuery = []
    if (data[dbFieldNameCount] !== null) {
        let dataSearch = (filterDelSpaces(data[dbFieldNameCount]).split(&quot;,&quot;))
        let occurrences = countOccurrencesFromArray(dataSearch)
        if (dataSearch.length &gt; 0) {
            return dataSearch.map(result =&gt; {
                //search the number of ? indicated in request
                if (result === &quot;?&quot;) {
                    return {
                        $match: {
                            [paramsOrResults]: {$elemMatch: {type: {$regex: &quot;&quot;}}, $size: dataSearch.length}
                        }
                    }
                } else if (dataSearch.length === 1 &amp;&amp; result === &quot;&quot;) {
                    return {$match: {[paramsOrResults]: {$size: 0}}}
                } //else search all param by params type and numbers of these types
                else if (dataSearch.length &gt;= 1) {
                    return {
                        $match: {
                            [paramsOrResults]: {$elemMatch: {type: result}, $size: dataSearch.length},
                            [dbFieldNameCount + &quot;.&quot; + result]: {
                                $lte: (occurrences[&quot;?&quot;] ? occurrences[&quot;?&quot;] : 0) + occurrences[result],
                                $gte: occurrences[result]
                            }
                        }
                    }
                }
                // else, there isn&apos;t any params in request, we search by other criteria
                else {
                    return {$match: {[paramsOrResults]: {$elemMatch: {type: {$regex: &quot;&quot;}}}}}
                }
            })
        } else if (dataSearch.length === 0) {
            return [{$match: {[paramsOrResults]: {$size: dataSearch.length}}}]
        }
    }
    return paramOrResultTypeQuery;
}

/** @function
 * @name getParamTypeQuery
 * Get a query to search function param&apos;s types in DB
 * @param {object} data - post&apos;s data
 * @returns {{$match: {params: {$size: number}}}[]|unknown[]|[]}
 */
function getParamTypeQuery(data) {
    return getTabParamOrReturn(data, &quot;paramsTypes&quot;, &quot;params&quot;);
}

/** @function
 * @name getReturnTypeQuery
 * Get a query to search function return&apos;s types in DB
 * @param {object} data - post&apos;s data
 * @returns {*[]|{$match: {field: {$regex: data}}}[]}
 */
function getReturnTypeQuery(data) {
    return getTabParamOrReturn(data, &quot;returnsTypes&quot;, &quot;returns&quot;);
}
//endregion

//region query for string
/** @function
 * @name getDescriptionQuery
 * Get a query to search function&apos;s description in DB
 * @param {object} data - post&apos;s data
 * @returns {*[]|{$match: {field: {$regex: data}}}[]}
 */
function getDescriptionQuery(data) {
    return getMatchStringRegex (data.description, &quot;post.description&quot;)
}

/** @function
 * @name getNameQuery
 * Get a query to search function&apos;s name in DB
 * @param {object} data - post&apos;s data
 * @returns {*[]|{$match: {field: {$regex: data}}}[]}
 */
function getNameQuery(data) {
    return getMatchStringRegex (data.functionName, &quot;name&quot;)
}

/** @function
 * @name getMatchStringRegex
 * Return a $match filter for a defined DB field
 * @param {string|null} data - a string that will be used in regex, if null return an empty array
 * @param {string} dbField - DB field from where to match a value
 * @returns {*[]|{$match: {field: {$regex:data}}}[]}
 */
function getMatchStringRegex(data, dbField){
    if (data !== null) {
        return [{$match: {[dbField]: {$regex: data}}}];
    }
    return []
}
//endregion

//endregion


module.exports = {getPipeline}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
