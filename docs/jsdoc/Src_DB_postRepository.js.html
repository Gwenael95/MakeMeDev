<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Src/DB/postRepository.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/Gwenael95/MakeMeDev" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="CustomEnvironment.html">CustomEnvironment</a></li><li><a href="global.html#MemoryDatabaseServer">MemoryDatabaseServer</a></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.html">Controllers</a><ul class='members'><li data-type='member' style='display: none;'><a href="Controllers.html#.sendPost">sendPost</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.html#.addCommentary">addCommentary</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.addResponse">addResponse</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.getPost">getPost</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.sendVote">sendVote</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.signIn">signIn</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.signUp">signUp</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.updateFunction">updateFunction</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.updateUser">updateUser</a></li></ul></li><li></li><li><a href="DB.html">DB</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DB.html#.addPost">addPost</a></li><li data-type='method' style='display: none;'><a href="DB.html#.getPostByFunction">getPostByFunction</a></li><li data-type='method' style='display: none;'><a href="DB.html#.getPostById">getPostById</a></li><li data-type='method' style='display: none;'><a href="DB.html#.pushPostResponse">pushPostResponse</a></li><li data-type='method' style='display: none;'><a href="DB.html#.pushPostResponseCommentary">pushPostResponseCommentary</a></li><li data-type='method' style='display: none;'><a href="DB.html#.signIn">signIn</a></li><li data-type='method' style='display: none;'><a href="DB.html#.signUp">signUp</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updateLikeOrDislike">updateLikeOrDislike</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updatePost">updatePost</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updatePostFunction">updatePostFunction</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updateUser">updateUser</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updateUserById">updateUserById</a></li></ul></li><li></li><li><a href="Middleware.html">Middleware</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.html#.authenticateToken">authenticateToken</a></li><li data-type='method' style='display: none;'><a href="Middleware.html#.handleGetPost">handleGetPost</a></li></ul></li><li><a href="Services.html">Services</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Services.html#.addCommentary">addCommentary</a></li><li data-type='method' style='display: none;'><a href="Services.html#.addPostResponse">addPostResponse</a></li><li data-type='method' style='display: none;'><a href="Services.html#.addUser">addUser</a></li><li data-type='method' style='display: none;'><a href="Services.html#.closeUserAction">closeUserAction</a></li><li data-type='method' style='display: none;'><a href="Services.html#.closeUserUpdateAction">closeUserUpdateAction</a></li><li data-type='method' style='display: none;'><a href="Services.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="Services.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="Services.html#.getUser">getUser</a></li><li data-type='method' style='display: none;'><a href="Services.html#.updateFunction">updateFunction</a></li><li data-type='method' style='display: none;'><a href="Services.html#.updateUser">updateUser</a></li><li data-type='method' style='display: none;'><a href="Services.html#.updateVote">updateVote</a></li></ul></li><li></li><li><a href="Test_helper.html">Test_helper</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Test_helper.html#.expectedResponseOnUserUpsert">expectedResponseOnUserUpsert</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.expectedStatus">expectedStatus</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.expectExcept">expectExcept</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getAllPostReq">getAllPostReq</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getBodyRes">getBodyRes</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getPostAt">getPostAt</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getUserActivities">getUserActivities</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.prepareReqWithToken">prepareReqWithToken</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.requestPostVote">requestPostVote</a></li></ul></li><li><a href="Tools.html">Tools</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Tools.html#.addAuthor">addAuthor</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.addDate">addDate</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.connect">connect</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.countOccurrencesFromArray">countOccurrencesFromArray</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.disconnect">disconnect</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.emptyRequest">emptyRequest</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.filterDelSpaces">filterDelSpaces</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.filterPassword">filterPassword</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.generateAccessToken">generateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getDescriptionQuery">getDescriptionQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getHandlerForUserPost">getHandlerForUserPost</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getLastCommentaryId">getLastCommentaryId</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getLastResponseId">getLastResponseId</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getMatchFromStringArray">getMatchFromStringArray</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getMatchStringRegex">getMatchStringRegex</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getNameQuery">getNameQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getParamTypeQuery">getParamTypeQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getPipeline">getPipeline</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getReturnTypeQuery">getReturnTypeQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getSearchPost">getSearchPost</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getSearchValue">getSearchValue</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getStringDelimitedArea">getStringDelimitedArea</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getTabParamOrReturn">getTabParamOrReturn</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getTagQuery">getTagQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.isDefinedAndNotNull">isDefinedAndNotNull</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.isUndefinedOrNull">isUndefinedOrNull</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.replaceAllChar">replaceAllChar</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.returnFieldByRegex">returnFieldByRegex</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.setTypes">setTypes</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.setUpdateValue">setUpdateValue</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.sortAllPostByLike">sortAllPostByLike</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.sortPostByLikes">sortPostByLikes</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.truncate">truncate</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.updateDbHandler">updateDbHandler</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><h3>Global</h3><ul><li><a href="global.html#commentaryPost">commentaryPost</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#databaseHelper">databaseHelper</a></li><li><a href="global.html#getConnectionStringGetmongodbURI">getConnectionString
Get mongodb URI</a></li><li><a href="global.html#minimalPost">minimalPost</a></li><li><a href="global.html#mongoose">mongoose</a></li><li><a href="global.html#PORT">PORT</a></li><li><a href="global.html#post">post</a></li><li><a href="global.html#post0">post0</a></li><li><a href="global.html#PostModel">PostModel</a></li><li><a href="global.html#postSchema">postSchema</a></li><li><a href="global.html#rateLimiterConfig">rateLimiterConfig</a></li><li><a href="global.html#responsePost">responsePost</a></li><li><a href="global.html#searchRegex">searchRegex</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startStartmongodb">start
Start mongodb</a></li><li><a href="global.html#stopStopmongodb">stop
Stop mongodb</a></li><li><a href="global.html#supertest">supertest</a></li><li><a href="global.html#teardown">teardown</a></li><li><a href="global.html#url">url</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#userPassword">userPassword</a></li><li><a href="global.html#userPseudo">userPseudo</a></li><li><a href="global.html#userSchema">userSchema</a></li><li><a href="global.html#userSignIn">userSignIn</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Src/DB/postRepository.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace DB
 */
/**
 * This file requires {@link module:../Models/postModel}, {@link module:../Tools/DB/postPipeline},
 * {@link module:../Tools/DB/postHelper}.
 * @requires module:../Models/postModel"
 * @requires module:../Tools/DB/postPipeline
 * @requires module:../Tools/DB/postHelper
 */
const mongoose = require('mongoose');
const {postSchema} = require("../Models/postModel");
const {getPipeline} = require("../Tools/DB/postPipeline")
const {getLastResponseId, getLastCommentaryId} = require("../Tools/DB/postHelper")

/**
 * A mongoose post model
 * @type {Model&lt;Document>}
 */
const PostModel = mongoose.model('posts', postSchema)
const ObjectId = mongoose.Types.ObjectId;


//region get
/**
 * Get post in database depending on many criteria, and return the result of this try
 * @function
 * @memberOf DB
 * @name getPostByFunction
 * @param {object} searchedData - data to search in database
 * @returns {Promise&lt;{success: {success: T}}|{error: Error.ValidationError | {[p: string]: ValidatorError | CastError} | number}>}
 */
async function getPostByFunction(searchedData) {
    return await PostModel
        .aggregate(getPipeline(searchedData))//.sort({"post.totalLike":1})
        .exec()
        .then(result => {return {success: result}})
        .catch(err => {
            return {error: err.errors}
        });
}

/**
 * Get post in database depending on post's Id, and return the result of this try
 * @function
 * @memberOf DB
 * @name getPostById
 * @param {object} postId - post's Id to search in database
 * @returns {Promise&lt;{success: {success: T}}|{error: Error.ValidationError | {[p: string]: ValidatorError | CastError} | number}>}
 */
async function getPostById(postId) {
    return await PostModel
        .findOne({$or : [ {_id: ObjectId(postId)}, {"post._id":ObjectId(postId)}]})
        .exec()
        .then(result => {return {success: result}})
        .catch(err => {
            return {error: err.errors}
        });
}
//endregion

//region post
/**
 * Insert a new post in database, and return the result of this try
 * @function
 * @memberOf DB
 * @name addPost
 * @param {object} postData - post to add, should correspond to postModels {@link '../Models/postModels'}.
 * @returns {Promise&lt;{success: {success: T}}|{error: Error.ValidationError | {[p: string]: ValidatorError | CastError} | number}>}
 */
async function addPost(postData) {
    const doc = new PostModel(postData);
    return await doc.save().then(result => {
        return {success: result}
    }).catch(err => {
        return {error: err.errors}
    })
}
//endregion

//region patch

/**
 * A generic function used to update a post.
 * @function
 * @memberOf DB
 * @name updatePost
 * @param {object} filter - object used by mongoDB to select corresponding documents in DB.
 * @param {object} update - object containing fields to set (ex: $set, or $push).
 * @param {string} id - a post's id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}>}
 */
async function updatePost(filter, update, id) {
    return await PostModel
        .findOneAndUpdate(
            filter,
            update,
            {new: true, context: "query"})
        .lean()
        .exec()
        .then((result ) => {
            return {success: result, postId: id , responseId: getLastResponseId(result), commentaryId: getLastCommentaryId(result, id)}
        })
        .catch(err => {
            return {error: err.errors}
        });
}

/**
 * Update a post function.
 * @function
 * @memberOf DB
 * @name updatePostFunction
 * @param {string} functionPost - the new function
 * @param {string} idPost - a post's id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}>}
 */
async function updatePostFunction(functionPost, idPost) {
    return await updatePost({"post._id": ObjectId(idPost)}, {$set : {"post.$.function": functionPost}}, idPost)
}

/**
 * Add a post response.
 * @function
 * @memberOf DB
 * @name pushPostResponse
 * @param {object} responsePost - a new response post to add in an array in DB
 * @param idPost - a post's id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}>}
 */
async function pushPostResponse(responsePost, idPost) {
    return await updatePost({"_id": ObjectId(idPost)}, {$push : {post: responsePost}}, idPost)
}

/**
 * Add a post commentary.
 * @function
 * @memberOf DB
 * @name pushPostResponseCommentary
 * @param {object} commentaryResponse -  a new commentary to add in an array in DB
 * @param idPost - a post's id
 * @returns {Promise&lt;{commentaryId: (null|undefined), success: {commentaryId: (null|undefined), success: T, postId: *, responseId: *}, postId: *, responseId: *}|{error}>}
 */
async function pushPostResponseCommentary(commentaryResponse, idPost) {
    return await updatePost({"post._id": ObjectId(idPost)}, {$push : {"post.$.commentary": commentaryResponse}}, idPost)
}

/**
 * Add or update like/dislike for a post.
 * start by checking if user already vote for this post.
 * if not we increment the like/dislike counter.
 * else, if it changes is mind (want to change a like by a dislike), we decrement
 * the old vote and increase the new one.
 * @function
 * @memberOf DB
 * @name updateLikeOrDislike
 * @param {string} likeOrDislike - a string equals to 'like' or 'dislike'
 * @param {string} idPost - post's id
 * @param {object} user - user's data (needed to know his activities)
 * @returns {Promise&lt;{error: string}|*>}
 */
async function updateLikeOrDislike(likeOrDislike, idPost, user) {
    /**
     * A string, opposite to the current vote
     * @type {string}
     */
    let opposite = {like:"dislike", dislike:"like"}[likeOrDislike]
    /**
     * An object containing fields to set in DB
     * @type {object}
     */
    let setPost

    if (!(user.activities[likeOrDislike].includes(idPost) || user.activities[opposite].includes( idPost))) {
        setPost = {$inc: {["post.$." + likeOrDislike]:1}}
    }
    else if(user.activities[opposite].includes( idPost)) {
        setPost = {$inc: {["post.$." + likeOrDislike]:1, ["post.$." + opposite]:-1}}
    }
    else{
        return {error:"cet utilisateur à déjà mis un " + likeOrDislike}
    }
    return await updatePost({"post._id": ObjectId(idPost)}, setPost, idPost)
}
//endregion


module.exports = {addPost, getPostByFunction, getPostById, updateLikeOrDislike,
    pushPostResponse, pushPostResponseCommentary, updatePostFunction};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Fri Dec 18 2020 03:38:40 GMT+0100 (Central European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
