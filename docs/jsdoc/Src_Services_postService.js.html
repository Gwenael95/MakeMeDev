<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Src/Services/postService.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/Gwenael95/MakeMeDev" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="CustomEnvironment.html">CustomEnvironment</a></li><li><a href="global.html#MemoryDatabaseServer">MemoryDatabaseServer</a></li></ul><h3>Namespaces</h3><ul><li><a href="Controllers.html">Controllers</a><ul class='members'><li data-type='member' style='display: none;'><a href="Controllers.html#.sendPost">sendPost</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Controllers.html#.addCommentary">addCommentary</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.addResponse">addResponse</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.getPost">getPost</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.sendVote">sendVote</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.signIn">signIn</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.signUp">signUp</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.updateFunction">updateFunction</a></li><li data-type='method' style='display: none;'><a href="Controllers.html#.updateUser">updateUser</a></li></ul></li><li></li><li><a href="DB.html">DB</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DB.html#.addPost">addPost</a></li><li data-type='method' style='display: none;'><a href="DB.html#.getPostByFunction">getPostByFunction</a></li><li data-type='method' style='display: none;'><a href="DB.html#.getPostById">getPostById</a></li><li data-type='method' style='display: none;'><a href="DB.html#.pushPostResponse">pushPostResponse</a></li><li data-type='method' style='display: none;'><a href="DB.html#.pushPostResponseCommentary">pushPostResponseCommentary</a></li><li data-type='method' style='display: none;'><a href="DB.html#.signIn">signIn</a></li><li data-type='method' style='display: none;'><a href="DB.html#.signUp">signUp</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updateLikeOrDislike">updateLikeOrDislike</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updatePost">updatePost</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updatePostFunction">updatePostFunction</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updateUser">updateUser</a></li><li data-type='method' style='display: none;'><a href="DB.html#.updateUserById">updateUserById</a></li></ul></li><li></li><li><a href="Middleware.html">Middleware</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Middleware.html#.authenticateToken">authenticateToken</a></li><li data-type='method' style='display: none;'><a href="Middleware.html#.handleGetPost">handleGetPost</a></li></ul></li><li><a href="Services.html">Services</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Services.html#.addCommentary">addCommentary</a></li><li data-type='method' style='display: none;'><a href="Services.html#.addPostResponse">addPostResponse</a></li><li data-type='method' style='display: none;'><a href="Services.html#.addUser">addUser</a></li><li data-type='method' style='display: none;'><a href="Services.html#.closeUserAction">closeUserAction</a></li><li data-type='method' style='display: none;'><a href="Services.html#.closeUserUpdateAction">closeUserUpdateAction</a></li><li data-type='method' style='display: none;'><a href="Services.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="Services.html#.get">get</a></li><li data-type='method' style='display: none;'><a href="Services.html#.getUser">getUser</a></li><li data-type='method' style='display: none;'><a href="Services.html#.updateFunction">updateFunction</a></li><li data-type='method' style='display: none;'><a href="Services.html#.updateUser">updateUser</a></li><li data-type='method' style='display: none;'><a href="Services.html#.updateVote">updateVote</a></li></ul></li><li></li><li><a href="Test_helper.html">Test_helper</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Test_helper.html#.expectedResponseOnUserUpsert">expectedResponseOnUserUpsert</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.expectedStatus">expectedStatus</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.expectExcept">expectExcept</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getAllPostReq">getAllPostReq</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getBodyRes">getBodyRes</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getPostAt">getPostAt</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.getUserActivities">getUserActivities</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.prepareReqWithToken">prepareReqWithToken</a></li><li data-type='method' style='display: none;'><a href="Test_helper.html#.requestPostVote">requestPostVote</a></li></ul></li><li><a href="Tools.html">Tools</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Tools.html#.addAuthor">addAuthor</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.addDate">addDate</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.connect">connect</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.countOccurrencesFromArray">countOccurrencesFromArray</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.disconnect">disconnect</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.emptyRequest">emptyRequest</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.filterDelSpaces">filterDelSpaces</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.filterPassword">filterPassword</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.generateAccessToken">generateAccessToken</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getDescriptionQuery">getDescriptionQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getHandlerForUserPost">getHandlerForUserPost</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getLastCommentaryId">getLastCommentaryId</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getLastResponseId">getLastResponseId</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getMatchFromStringArray">getMatchFromStringArray</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getMatchStringRegex">getMatchStringRegex</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getNameQuery">getNameQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getParamTypeQuery">getParamTypeQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getPipeline">getPipeline</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getReturnTypeQuery">getReturnTypeQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getSearchPost">getSearchPost</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getSearchValue">getSearchValue</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getStringDelimitedArea">getStringDelimitedArea</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getTabParamOrReturn">getTabParamOrReturn</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.getTagQuery">getTagQuery</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.isDefinedAndNotNull">isDefinedAndNotNull</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.isUndefinedOrNull">isUndefinedOrNull</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.replaceAllChar">replaceAllChar</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.returnFieldByRegex">returnFieldByRegex</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.setTypes">setTypes</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.setUpdateValue">setUpdateValue</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.sortAllPostByLike">sortAllPostByLike</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.sortPostByLikes">sortPostByLikes</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.truncate">truncate</a></li><li data-type='method' style='display: none;'><a href="Tools.html#.updateDbHandler">updateDbHandler</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><h3>Global</h3><ul><li><a href="global.html#commentaryPost">commentaryPost</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#databaseHelper">databaseHelper</a></li><li><a href="global.html#getConnectionStringGetmongodbURI">getConnectionString
Get mongodb URI</a></li><li><a href="global.html#minimalPost">minimalPost</a></li><li><a href="global.html#mongoose">mongoose</a></li><li><a href="global.html#PORT">PORT</a></li><li><a href="global.html#post">post</a></li><li><a href="global.html#post0">post0</a></li><li><a href="global.html#PostModel">PostModel</a></li><li><a href="global.html#postSchema">postSchema</a></li><li><a href="global.html#rateLimiterConfig">rateLimiterConfig</a></li><li><a href="global.html#responsePost">responsePost</a></li><li><a href="global.html#searchRegex">searchRegex</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startStartmongodb">start
Start mongodb</a></li><li><a href="global.html#stopStopmongodb">stop
Stop mongodb</a></li><li><a href="global.html#supertest">supertest</a></li><li><a href="global.html#teardown">teardown</a></li><li><a href="global.html#url">url</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#userPassword">userPassword</a></li><li><a href="global.html#userPseudo">userPseudo</a></li><li><a href="global.html#userSchema">userSchema</a></li><li><a href="global.html#userSignIn">userSignIn</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Src/Services/postService.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @namespace Services
 */
/**
 * This Service file requires {@link module:../DB/postRepository }, {@link module:../DB/userRepository},
 * {@link module:../Tools/token}, {@link module:../Tools/Services/searchPost },
 * {@link module:../Tools/Common/undefinedControl }, {@link module:../Tools/Services/addField}
 * {@link module:../Tools/Services/sortPost} and {@link module:../Tools/Services/responseHandler}

 * @requires module:../DB/postRepository
 * @requires module:../DB/userRepository
 * @requires module:../Tools/token
 * @requires module:../Tools/Services/searchPost
 * @requires module:../Tools/Common/undefinedControl
 * @requires module:../Tools/Services/addField
 * @requires module:../Tools/Services/sortPost
 * @requires module:../Tools/Services/responseHandler
 */
const { addPost, getPostByFunction, getPostById, updateLikeOrDislike, pushPostResponse,
        pushPostResponseCommentary, updatePostFunction} = require("../DB/postRepository");
const { updateUserById} = require("../DB/userRepository");

//region Tools
const { generateAccessToken} = require("../Tools/token");
const { getSearchPost} = require("../Tools/Services/searchPost");
const { isDefinedAndNotNull} = require("../Tools/Common/undefinedControl");
const { addDate, addAuthor, setTypes} = require("../Tools/Services/addField");
const { sortPostByLikes, sortAllPostByLike} = require("../Tools/Services/sortPost");
const { getHandler, getHandlerForUserPost, updateDbHandler} = require("../Tools/Services/responseHandler");
//endregion

//region exported methods
//region get
/**
 * Get posts depending on a request get thanks to a string with strict typography to demarcate
 * each field, and if not exist it will not be a criteria to search at all.
 * Structure : functionName(param1, param2, ?){returned1, returned2}"functionDescription"[tag1, tag2, tag3]
 * OR use a post id to get the corresponding post.
 * @function
 * @memberOf Services
 * @name get
 * @param {object} search - search field to find in database
 * @returns {Promise&lt;{code: number, body: {error: *}}|{code: number, body: *}|{code: number, body: *}|{code: number, body: {error: string}}>}
 */
async function get(search) {
    if (isDefinedAndNotNull(search.search)) {
        const objectSearchPost = getSearchPost(search.search)
        let queryRes = await getPostByFunction(objectSearchPost);
        return getHandler(sortAllPostByLike(queryRes), "No post exists with these details");
    }
    else {
        let queryRes = await getPostById(search.postId);
        queryRes.success = sortPostByLikes(queryRes.success)
        return getHandler(queryRes, "No post exists with this id");
    }
}
//endregion

//region post
/**
 * Create a new post, that will be add in database.
 * We add some field : paramsTypes and returnsTypes to have an object with a number of occurrence of each params.
 * Also creation date for post
 * It will make it simpler to search post depending on the amount of params or returns with getPost function.
 * @function
 * @memberOf Services
 * @name create
 * @param {object} post - post to add, should be really similar to postModels {@link '../Models/postModels'}.
 * @param {object} user - user to update, should be really similar to userModels {@link '../Models/userModels'}.
 * @returns {Promise&lt;{code: number, body: {success: {post: (string|boolean|SrvPoller.success|Event), user: (string|boolean|SrvPoller.success|Event)}, token: *}}|{code: number, body: {error: string}}|{code: number, body: *}>}
 */
async function create(post, user) {
    try {
        setTypes(post, "params");
        setTypes(post, "returns");
        addAuthor(user ,post)
        addAuthor(user ,post.post[0])
        addDate(post.post[0])
        addDate(post)

        const result = await addPost(post);
        if (result.success) {
            const userRes = await updateUserById({id: user._id}, {$push: {post: result.success._id}});
            return closeUserUpdateAction(userRes, result, "Post created, but can't update user's data")
        }
        return updateDbHandler(result, "Error when creating post", 500);
    }
    catch (e) {
        return updateDbHandler({error: "Can't create this post: bad request"})
    }
}
//endregion

//region patch
/**
 * Update a function from a post or post response thanks to its id.
 * @function
 * @memberOf Services
 * @name updateFunction
 * @param {string} functionPost - the complete function, real code that could be run.
 * @param {string} idPost - post's or response post's id to update
 * @param {object} user - current user's data
 * @todo Check if current user if post or post response author
 * @returns {Promise&lt;{code: number, body: {error: string}}|{code: number, body: *}>}
 */
async function updateFunction(functionPost, idPost, user) {
    if (functionPost) {
        return updateDbHandler(await updatePostFunction(functionPost, idPost), "Error when updating post function", 500)
    }
    return updateDbHandler({error: "Update function failed"}, "can't update post function: no functionPost found");
}

/**
 * Used to add or update a vote in DB for a post. Then we update user to know if it already have
 * like or dislike a function.
 * @function
 * @memberOf Services
 * @name updateVote
 * @param {int|string} vote - vote value. If it's an int, 1="like" &amp; -1="dislike"
 * @param {string} idPost - post's id
 * @param {object} user - user's data
 * @returns {Promise&lt;{code: number, body: {success: {post: (string|boolean|SrvPoller.success|Event), user: (string|boolean|SrvPoller.success|Event)}, token: *}}|{code: number, body: {error: string}}|{code: number, body: *}>}
 */
async function updateVote(vote, idPost, user) {
    const likeOrDislike = vote === 1 || vote === "like" ? "like" : "dislike"
    const opposite = vote === 1 || vote === "like" ? "dislike" : "like"
    let result = await updateLikeOrDislike(likeOrDislike, idPost, user)

    //check if updated , then update user
    if (isDefinedAndNotNull(result.success)) {
        const userRes = await updateUserById({id: user._id}, {
            $push: {["activities." + likeOrDislike]: result.postId},
            $pull: {["activities." + opposite]: result.postId}
        })
        result.success = sortPostByLikes(result.success)
        return closeUserUpdateAction(userRes, result, "Adding " + likeOrDislike + " on post with id= " + idPost + " is impossible")
    }
    return updateDbHandler({error: "Update vote failed"}, "Can't update vote post", 500);
}

/**
 * Add a response to a post (with a new function proposal) after adding author and date.
 * Then we update user to save in his activities he post a response.
 * @function
 * @memberOf Services
 * @name addPostResponse
 * @param {object} responsePost - a response to a post
 * @param {string} idPost - post's id
 * @param {object} user - user's data
 * @returns {Promise&lt;{code: number, body: {success: {post: (string|boolean|SrvPoller.success|Event), user: (string|boolean|SrvPoller.success|Event)}, token: *}}|{code: number, body: {error: string}}|{code: number, body: *}>}
 */
async function addPostResponse(responsePost, idPost, user) {
    addAuthor(user, responsePost)
    addDate(responsePost)
    if (responsePost['function'] &amp;&amp; responsePost['description']) {
        const result = await pushPostResponse(responsePost, idPost)
        if (result.success !== null &amp;&amp; result.success !== undefined) {
            const userRes = await updateUserById({id: user._id}, {$push: {["activities.response"]: result.responseId}})
            result.success = sortPostByLikes(result.success)
            return closeUserUpdateAction(userRes, result, "Add a new response,but can't update user's data")
        }
    }
    return updateDbHandler({error: "Adding response failed"}, "Can't add response to post");
}

/**
 * Add a commentary to a post after adding author and date. Then we update user to save in his
 * activities he add a commentary to a post.
 * @function
 * @memberOf Services
 * @name addCommentary
 * @param {object} commentaryPost - a commentary post
 * @param {string} idPost - post's id
 * @param {object} user - user's data
 * @returns {Promise&lt;{code: number, body: {success: {post: (string|boolean|SrvPoller.success|Event), user: (string|boolean|SrvPoller.success|Event)}, token: *}}|{code: number, body: {error: string}}|{code: number, body: *}>}
 */
async function addCommentary(commentaryPost, idPost, user) {
    addAuthor(user, commentaryPost)
    addDate(commentaryPost, "date")
    if (commentaryPost['commentary']) {
        const result = await pushPostResponseCommentary(commentaryPost, idPost)
        if (result.success !== null &amp;&amp; result.success !== undefined) {
            const userRes = await updateUserById({id: user._id}, {$push: {["activities.commentary"]: result.postId}})
            result.success = sortPostByLikes(result.success)
            return closeUserUpdateAction(userRes, result, "Add a new commentary, but can't update user's data")
        }
    }
    return updateDbHandler({error: "Adding commentary failed"}, "Can't add a commentary");
}
//endregion
//endregion


//region not exported functions
/**

 * This function is used to close action. We generate a new token
 * and return a http code status and body.
 * @function
 * @memberOf Services
 * @name closeUserUpdateAction
 * @param {object} userData - user's data from a response
 * @param {object} postData - post's data from a response
 * @param {string } [msg= "DB error"] - message to send in body if there is an issue
 * @returns {{code: number, body: {success: {post: (string|boolean|SrvPoller.success|Event), user: (string|boolean|SrvPoller.success|Event)}, token: *}}|{code: number, body: {error: string}}|{code: number, body: *}}
 */
function closeUserUpdateAction(userData, postData, msg="DB error"){
    generateAccessToken(userData)
    return getHandlerForUserPost(userData, postData, msg);
}

//endregion

module.exports = {create, get, updateVote, addPostResponse, addCommentary, updateFunction};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Fri Dec 18 2020 10:26:25 GMT+0100 (Central European Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
